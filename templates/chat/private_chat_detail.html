{% extends 'base.html' %}

{% block title %}Private Chat with {{ other_user.get_full_name|default:other_user.username }} - eLearning Platform{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card" style="height: 80vh;">
                <!-- Chat Header -->
                <div class="card-header bg-primary text-white py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <a href="{% url 'chat:private_list' %}" class="btn btn-sm btn-outline-light mr-2">
                                <i class="fas fa-arrow-left"></i>
                            </a>
                            <h6 class="mb-0">
                                <i class="fas fa-user-circle mr-1"></i>
                                {{ other_user.get_full_name|default:other_user.username }}
                                <small class="ml-2 opacity-75">
                                    ({% if other_user.user_type == 'teacher' %}Teacher{% else %}Student{% endif %})
                                </small>
                            </h6>
                        </div>
                        <div>
                            <small id="chat-connection-status" class="text-warning text-nowrap">
                                <i class="fas fa-circle mr-1"></i><span id="chat-connection-text">Connecting</span>
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Messages Container -->
                <div class="card-body p-0 d-flex flex-column" style="height: calc(80vh - 120px);">
                    <div id="messages-container" class="flex-grow-1 overflow-auto p-3" style="max-height: calc(80vh - 200px);">
                        {% for message in messages %}
                        <div class="message mb-3 {% if message.sender == user %}text-right{% endif %}">
                            <div class="d-inline-block max-width-75 {% if message.sender == user %}bg-primary text-white{% else %}bg-light{% endif %} rounded p-2">
                                {% if message.sender != user %}
                                <small class="text-muted d-block">
                                    <strong>{{ message.sender.get_full_name|default:message.sender.username }}</strong>
                                </small>
                                {% endif %}
                                <div>{{ message.content }}</div>
                                <small class="text-{% if message.sender == user %}light{% else %}muted{% endif %} d-block mt-1">
                                    {{ message.created_at|date:"M d, H:i" }}
                                </small>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <p>No messages yet. Start the conversation!</p>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Message Input -->
                    <div class="border-top p-3">
                        <form id="message-form" class="d-flex">
                            {% csrf_token %}
                            <input type="text" 
                                   id="message-input" 
                                   class="form-control mr-2" 
                                   placeholder="Type your message..." 
                                   maxlength="500"
                                   autocomplete="off">
                            <button type="submit" class="btn btn-primary" id="send-btn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                        <small class="text-muted mt-1">Press Enter to send</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.max-width-75 {
    max-width: 75%;
}

#messages-container {
    scroll-behavior: smooth;
}

.message:last-child {
    margin-bottom: 0 !important;
}

/* Connection status styling */
#chat-connection-status {
    white-space: nowrap;
    font-size: 0.8rem;
}

#chat-connection-status i.fa-circle {
    font-size: 0.6rem;
}

#chat-connection-status.text-success {
    color: #28a745 !important;
}

#chat-connection-status.text-warning {
    color: #ffc107 !important;
}

#chat-connection-status.text-danger {
    color: #dc3545 !important;
}

/* Compact header */
.card-header.py-2 {
    padding-top: 0.5rem !important;
    padding-bottom: 0.5rem !important;
}

@media (max-width: 768px) {
    .max-width-75 {
        max-width: 90%;
    }
    
    #connection-status {
        font-size: 0.7rem;
    }
}</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const otherId = {{ other_user.id }};
    const currentUserId = {{ user.id }};
    const messagesContainer = document.getElementById('messages-container');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const connectionStatus = document.getElementById('chat-connection-status');
    const connectionText = document.getElementById('chat-connection-text');
    
    // WebSocket connection
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/chat/private/${otherId}/`;
    const socket = new WebSocket(wsUrl);
    
    socket.onopen = function(e) {
        connectionStatus.className = 'text-success text-nowrap';
        connectionText.textContent = 'Connected';
    };
    
    socket.onclose = function(e) {
        connectionStatus.className = 'text-danger text-nowrap';
        connectionText.textContent = 'Disconnected';
        
        // Try to reconnect after 3 seconds
        setTimeout(function() {
            location.reload();
        }, 3000);
    };
    
    socket.onerror = function(e) {
        connectionStatus.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> Connection Error';
        connectionStatus.className = 'text-warning';
    };
    
    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.type === 'message') {
            addMessageToChat(data);
        }
    };
    
    // Send message
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        
        if (message) {
            const messageData = {
                type: 'message',
                message: message,
                sender_id: currentUserId
            };
            
            socket.send(JSON.stringify(messageData));
            messageInput.value = '';
        }
    });
    
    // Add message to chat
    function addMessageToChat(data) {
        // Prevent duplicate messages by checking if message already exists
        const existingMessages = messagesContainer.querySelectorAll('.message');
        const messageText = data.message.trim();
        const senderName = data.sender;
        
        // Check if this exact message from this sender already exists in the last few messages
        let isDuplicate = false;
        for (let i = Math.max(0, existingMessages.length - 5); i < existingMessages.length; i++) {
            const msgElement = existingMessages[i];
            const msgContent = msgElement.textContent || msgElement.innerText;
            if (msgContent.includes(messageText) && msgContent.includes(senderName)) {
                isDuplicate = true;
                break;
            }
        }
        
        if (isDuplicate) {
            return; // Don't add duplicate message
        }
        
        const messageDiv = document.createElement('div');
        const isCurrentUser = data.sender_id === currentUserId;
        const timestamp = new Date().toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        messageDiv.className = `message mb-3 ${isCurrentUser ? 'text-right' : ''}`;
        messageDiv.innerHTML = `
            <div class="d-inline-block max-width-75 ${isCurrentUser ? 'bg-primary text-white' : 'bg-light'} rounded p-2">
                ${!isCurrentUser ? `<small class="text-muted d-block"><strong>${data.sender}</strong></small>` : ''}
                <div>${data.message}</div>
                <small class="text-${isCurrentUser ? 'light' : 'muted'} d-block mt-1">
                    ${timestamp}
                </small>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // Auto-scroll to bottom on page load
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Focus on input
    messageInput.focus();
    
    // Handle Enter key
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            messageForm.dispatchEvent(new Event('submit'));
        }
    });
});
</script>
{% endblock %}
